<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÅ Chat with Files - RAG Chat</title>
    <style>
        :root{ --focus: rgba(17,24,39,.35); --primary:#6366f1; --primaryDark:#4f46e5; --surface:#1a1a1a; --surface2:#242424; --border:#374151; --text:#fff; --muted:#a1a1aa; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background:#000; color:var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: var(--surface); padding: 18px 24px; border-bottom:1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header-icon { font-size: 1.4rem; background: linear-gradient(135deg, #ff6b9d, var(--primary)); padding: 10px; border-radius: 10px; color: white; }
        .header-text h1 { font-size: 1.2rem; font-weight: 800; color: var(--text); margin-bottom: 2px; }
        .header-text p { color: var(--muted); font-size: 0.9rem; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .home-btn { background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; text-decoration: none; }
        .home-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(100, 116, 139, 0.3); }
        .new-chat-btn { background: linear-gradient(135deg, var(--primary), var(--primaryDark)); color: white; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .new-chat-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3); }
        .logout-btn { background: var(--surface2); border:1px solid var(--border); color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; text-decoration: none; transition: all 0.2s ease; }
        .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 24px; flex: 1; display: flex; gap: 24px; }
        .sidebar { width: 300px; background: var(--surface2); border-radius: 14px; padding: 20px; border: 1px solid var(--border); height: fit-content; }
        .sidebar h3 { color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .chat-list { display: flex; flex-direction: column; gap: 10px; }
        .chat-item { padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; color:var(--text); }
        .chat-item:hover { background: rgba(99, 102, 241, 0.16); border-color: rgba(99, 102, 241, 0.3); }
        .chat-item.active { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }
        .chat-item-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        .chat-item-file { font-size: 0.8rem; opacity: 0.7; word-break: break-all; }
        .chat-area { flex: 1; background: var(--surface2); border-radius: 14px; padding: 24px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .file-input-section { background: rgba(99, 102, 241, 0.06); border-radius: 12px; padding: 18px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.2); }
        .upload-area { border: 2px dashed #475569; border-radius: 12px; padding: 40px 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative; background: rgba(36,36,36,.7); margin-bottom: 20px; }
        .upload-area:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.08); }
        .upload-area.dragover { border-color: #6366f1; background: rgba(99, 102, 241, 0.12); border-style: solid; }
        .upload-icon { font-size: 3rem; color: #9ca3af; margin-bottom: 15px; }
        .upload-text { color: #e5e7eb; font-size: 1.1rem; margin-bottom: 10px; font-weight: 600; }
        .upload-subtext { color: #a1a1aa; font-size: 0.9rem; margin-bottom: 15px; }
        .file-input { display: none; }
        .browse-btn { background: linear-gradient(135deg, var(--primary), var(--primaryDark)); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .browse-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
        .file-types { font-size: 0.85rem; color: var(--muted); margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .uploaded-files { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .file-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; transition: all 0.3s ease; color:var(--text); }
        .file-item:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .file-icon-type { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; font-weight: bold; }
        .pdf-icon { background: #dc2626; } .doc-icon { background: #2563eb; } .txt-icon { background: #059669; } .default-icon { background: #6b7280; }
        .file-details { flex: 1; }
        .file-name { font-weight: 600; color: var(--text); margin-bottom: 4px; font-size: 0.95rem; }
        .file-info { color: var(--muted); font-size: 0.8rem; }
        .remove-file { background: #ef4444; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .remove-file:hover { background: #dc2626; transform: scale(1.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .form-group textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; transition: all 0.2s ease; background: var(--surface); color:var(--text); }
        .form-group textarea:focus { outline: 3px solid transparent; border-color: var(--primary); box-shadow: 0 0 0 4px var(--focus); }
        .ask-btn { background: linear-gradient(135deg, var(--primary), var(--primaryDark)); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.2s ease; display: flex; align-items: center; gap: 10px; justify-content: center; }
        .ask-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3); }
        .ask-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 20px; max-height: 400px; padding-right: 10px; }
        .message { margin-bottom: 20px; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { text-align: right; }
        .message-bubble { display: inline-block; max-width: 80%; padding: 15px 20px; border-radius: 20px; word-wrap: break-word; }
        .message.user .message-bubble { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-bottom-right-radius: 5px; }
        .message.assistant .message-bubble { background: #0f172a; color: #e5e7eb; border: 1px solid #1f2937; border-bottom-left-radius: 5px; }
        .message-time { font-size: 0.8rem; opacity: 0.6; margin-top: 5px; }
        .loading-indicator { display: none; text-align: center; padding: 20px; }
        .loading-dots { display: inline-flex; gap: 4px; }
        .loading-dot { width: 8px; height: 8px; background: #6366f1; border-radius: 50%; animation: loading 1.4s infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loading { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        .empty-state { text-align: center; color: var(--muted); padding: 40px; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
        .files-info { background: rgba(16,185,129,.08); border: 1px solid rgba(16,185,129,.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none; color:var(--text); }
        .files-info.show { display: block; animation: fadeInUp 0.5s ease-out; }
        .files-info h4 { color: #10b981; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .files-summary { color: var(--muted); font-size: 0.9rem; margin-bottom: 10px; }
        .processing-status { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--muted); }
    </style>
</head>
<body>
    <a href="#main" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;">Skip to content</a>
    <div class="header" role="banner">
        <div class="header-content">
            <div class="header-title">
                <div class="header-icon">üìÅ</div>
                <div class="header-text">
                    <h1>Chat with Files</h1>
                    <p>Upload and analyze documents with AI assistance</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{% url 'home' %}" class="home-btn"><span>üè†</span> Home</a>
                <button class="new-chat-btn" onclick="createNewChat()"><span>‚ûï</span> New Chat</button>
                <a href="{% url 'logout' %}" class="logout-btn">üîì Logout</a>
            </div>
        </div>
    </div>

    <div class="main-container" role="main" id="main">
        <div class="sidebar">
            <h3><span>üìÑ</span> File Chats</h3>
            <div class="chat-list" id="chatList"></div>
            <div style="margin-top:12px; display:flex; gap:8px;">
                <button class="new-chat-btn" style="background:#ef4444" onclick="clearChatHistory()">üóëÔ∏è Clear History</button>
            </div>
        </div>

        <div class="chat-area">
            <div class="file-input-section">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Upload Files</div>
                    <div class="upload-subtext">Drag and drop files here or click to browse</div>
                    <button type="button" class="browse-btn">Choose Files</button>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.txt,.md,.rtf">
                    <div class="file-types"><span>üìÑ</span> Supports: PDF, DOC, DOCX, TXT, MD, RTF</div>
                </div>
                <div class="uploaded-files" id="uploadedFiles"></div>
                <div class="form-group">
                    <label for="userQuestion"><span>‚ùì</span> Your Question:</label>
                    <textarea id="userQuestion" rows="3" placeholder="Ask something about the uploaded documents..."></textarea>
                </div>
                <button class="ask-btn" id="askBtn" onclick="askQuestion()"><span>üöÄ</span> Analyze & Ask</button>
            </div>

            <div class="files-info" id="filesInfo">
                <h4><span>‚úÖ</span> Files Processed</h4>
                <div class="files-summary" id="filesSummary"></div>
                <div class="processing-status"><span>‚ö°</span> Ready for questions</div>
            </div>

            <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÅ</div>
                    <h3>Upload Files to Start</h3>
                    <p>Upload documents and ask questions to begin analyzing your files with AI.</p>
                </div>
            </div>

            <div class="loading-indicator" id="loadingIndicator">
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
                <p style="margin-top: 10px; color: #666;">Processing files and generating response...</p>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null; let chatHistory = {}; let chatCounter = 1; let uploadedFiles = [];
        function loadChatHistory() { const savedHistory = sessionStorage.getItem('fileChatHistory'); if (savedHistory) { chatHistory = JSON.parse(savedHistory); chatCounter = Object.keys(chatHistory).length + 1; updateChatList(); } }
        function saveChatHistory() { sessionStorage.setItem('fileChatHistory', JSON.stringify(chatHistory)); }
        function clearChatHistory() { if (confirm('Delete all file chats?')) { chatHistory = {}; currentChatId = null; chatCounter = 1; saveChatHistory(); updateChatList(); document.getElementById('chatMessages').innerHTML = `<div class=\"empty-state\"><div class=\"empty-state-icon\">üìÅ</div><h3>No chats</h3><p>Click New Chat to begin.</p></div>`; } }
        function getFileExtension(filename) { return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2); }
        function getFileIconClass(filename) { const ext = getFileExtension(filename).toLowerCase(); if (ext === 'pdf') return 'pdf-icon'; if (['doc', 'docx'].includes(ext)) return 'doc-icon'; if (['txt', 'md', 'rtf'].includes(ext)) return 'txt-icon'; return 'default-icon'; }
        function getFileTypeDisplay(filename) { const ext = getFileExtension(filename).toLowerCase(); if (ext === 'pdf') return 'PDF'; if (['doc', 'docx'].includes(ext)) return 'DOC'; if (['txt', 'md', 'rtf'].includes(ext)) return 'TXT'; return ext.toUpperCase(); }
        function formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i]; }
        function handleFiles(files) { Array.from(files).forEach(file => { if (!uploadedFiles.find(f => f.name === file.name && f.size === file.size)) { uploadedFiles.push(file); } }); displayUploadedFiles(); updateFilesInfo(); }
        function displayUploadedFiles() { const container = document.getElementById('uploadedFiles'); container.innerHTML = ''; uploadedFiles.forEach((file, index) => { const fileItem = document.createElement('div'); fileItem.className = 'file-item'; const iconClass = getFileIconClass(file.name); const typeDisplay = getFileTypeDisplay(file.name); fileItem.innerHTML = `<div class=\"file-icon-type ${iconClass}\">${typeDisplay}</div><div class=\"file-details\"><div class=\"file-name\">${file.name}</div><div class=\"file-info\">${formatFileSize(file.size)} ‚Ä¢ ${getFileExtension(file.name).toUpperCase()}</div></div><button class=\"remove-file\" onclick=\"removeFile(${index})\" title=\"Remove file\">√ó</button>`; container.appendChild(fileItem); }); }
        function removeFile(index) { uploadedFiles.splice(index, 1); displayUploadedFiles(); updateFilesInfo(); }
        function updateFilesInfo() { const filesInfo = document.getElementById('filesInfo'); const filesSummary = document.getElementById('filesSummary'); if (uploadedFiles.length > 0) { const totalSize = uploadedFiles.reduce((sum, file) => sum + file.size, 0); filesSummary.innerHTML = `${uploadedFiles.length} file(s) uploaded ‚Ä¢ ${formatFileSize(totalSize)} total`; filesInfo.classList.add('show'); } else { filesInfo.classList.remove('show'); } }
        function createNewChat() { currentChatId = `file_chat_${Date.now()}`; chatHistory[currentChatId] = { title: `File Chat ${chatCounter++}`, files: [], messages: [], created: new Date().toLocaleString() }; uploadedFiles = []; document.getElementById('uploadedFiles').innerHTML = ''; document.getElementById('userQuestion').value = ''; document.getElementById('chatMessages').innerHTML = `<div class=\"empty-state\"><div class=\"empty-state-icon\">üìÅ</div><h3>New File Chat Started</h3><p>Upload documents and ask a question to begin this conversation.</p></div>`; document.getElementById('filesInfo').classList.remove('show'); updateChatList(); saveChatHistory(); }
        function loadChat(chatId) { currentChatId = chatId; const chat = chatHistory[chatId]; uploadedFiles = []; document.getElementById('uploadedFiles').innerHTML = ''; document.getElementById('filesInfo').classList.remove('show'); const messagesContainer = document.getElementById('chatMessages'); messagesContainer.innerHTML = ''; if (chat.messages.length === 0) { messagesContainer.innerHTML = `<div class=\"empty-state\"><div class=\"empty-state-icon\">üìÅ</div><h3>Resume File Chat</h3><p>Upload files and continue chatting about your documents.</p></div>`; } else { chat.messages.forEach(message => { addMessageToChat(message.type, message.content, message.timestamp, false); }); if (chat.files.length > 0) { const filesSummary = document.getElementById('filesSummary'); filesSummary.innerHTML = `${chat.files.length} file(s) from previous session`; document.getElementById('filesInfo').classList.add('show'); } } updateChatList(); }
        function updateChatList() { const chatList = document.getElementById('chatList'); chatList.innerHTML = ''; if (Object.keys(chatHistory).length === 0) { chatList.innerHTML = `<div style=\"text-align: center; color: #666; padding: 20px;\"><p>No file chats yet.</p><p style=\"font-size: 0.8rem; margin-top: 5px;\">Click \"New Chat\" to start!</p></div>`; return; } Object.entries(chatHistory).reverse().forEach(([chatId, chat]) => { const chatItem = document.createElement('div'); chatItem.className = `chat-item ${chatId === currentChatId ? 'active' : ''}`; chatItem.onclick = () => loadChat(chatId); const fileCount = chat.files.length || 0; const displayText = fileCount > 0 ? `${fileCount} file(s)` : 'No files uploaded'; chatItem.innerHTML = `<div class=\"chat-item-title\">${chat.title}</div><div class=\"chat-item-file\">${displayText}</div><div style=\"font-size: 0.7rem; opacity: 0.6; margin-top: 5px;\">${chat.created}</div>`; chatList.appendChild(chatItem); }); }
        function addMessageToChat(type, content, timestamp, save = true) { const messagesContainer = document.getElementById('chatMessages'); const emptyState = messagesContainer.querySelector('.empty-state'); if (emptyState) { emptyState.remove(); } const messageDiv = document.createElement('div'); messageDiv.className = `message ${type}`; const time = timestamp || new Date().toLocaleTimeString(); messageDiv.innerHTML = `<div class=\"message-bubble\">${content}</div><div class=\"message-time\">${time}</div>`; messagesContainer.appendChild(messageDiv); messagesContainer.scrollTop = messagesContainer.scrollHeight; if (save && currentChatId) { chatHistory[currentChatId].messages.push({ type: type, content: content, timestamp: time }); saveChatHistory(); } }
        async function askQuestion() { const question = document.getElementById('userQuestion').value.trim(); if (uploadedFiles.length === 0 || !question) { alert('Please upload at least one file and enter a question.'); return; } if (!currentChatId) { createNewChat(); } addMessageToChat('user', question); document.getElementById('userQuestion').value = ''; document.getElementById('loadingIndicator').style.display = 'block'; document.getElementById('askBtn').disabled = true; try { const form = new FormData(); form.append('question', question); form.append('file', uploadedFiles[0]); const resp = await fetch('/api/files/', { method: 'POST', body: form }); const data = await resp.json(); if (!resp.ok) throw new Error(data.error || 'Request failed'); addMessageToChat('assistant', data.answer || ''); } catch (e) { addMessageToChat('assistant', `Error: ${e.message}`); } finally { document.getElementById('loadingIndicator').style.display = 'none'; document.getElementById('askBtn').disabled = false; } }
        const uploadArea = document.getElementById('uploadArea'); const fileInput = document.getElementById('fileInput'); uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); }); uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover')); uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files && e.dataTransfer.files.length > 0) { handleFiles(e.dataTransfer.files); e.dataTransfer.clearData(); } }); fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        loadChatHistory(); if (Object.keys(chatHistory).length === 0) { createNewChat(); }
    </script>
</body>
</html>

